<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>Collapse.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* sxr -- Scala X-Ray
 * Copyright 2009 Mark Harrah
 */</span>

<span class="keyword">package</span> sxr

<span class="keyword">private</span> <span class="keyword">object</span> <a title="object sxr.Collapse" id="9503">Collapse</a>
<span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(tokens: Iterable[sxr.Token], links: sxr.LinkMap)Unit" id="48524">apply</a><span class="delimiter">(</span><a title="Iterable[sxr.Token]" id="48526">tokens</a>: <span title="Iterable[sxr.Token]">Iterable</span><span class="delimiter">[</span>Token<span class="delimiter">]</span>, <a title="sxr.LinkMap" id="48527">links</a>: <a href="LinkMap.scala.html#9532" title="sxr.LinkMap">LinkMap</a><span class="delimiter">)</span>
  <span class="delimiter">{</span>
    <a href="#48525" title="(tokens: Iterable[sxr.Token])Unit">eliminateDuplicates</a><span class="delimiter">(</span><a href="#48526" title="Iterable[sxr.Token]">tokens</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="sxr.Collapse" id="53320">c</a> = <span title="sxr.Collapse" class="keyword">new</span> <a href="#9505" title="sxr.Collapse">Collapse</a><span class="delimiter">(</span><a href="#48526" title="Iterable[sxr.Token]">tokens</a>, <a href="#48527" title="sxr.LinkMap">links</a><span class="delimiter">)</span>
    <a href="#53271" title="()Unit">c</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(tokens: Iterable[sxr.Token])Unit" id="48525">eliminateDuplicates</a><span class="delimiter">(</span><a title="Iterable[sxr.Token]" id="53321">tokens</a>: <span title="Iterable[sxr.Token]">Iterable</span><span class="delimiter">[</span>Token<span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Int,Int]" id="53362">idOccurrences</a> = <span title="()scala.collection.mutable.HashMap[Int,Int]" class="keyword">new</span> scala.collection.mutable.<span title="scala.collection.mutable.HashMap[Int,Int]">HashMap</span><span class="delimiter">[</span>Int, Int<span class="delimiter">]</span> <span class="comment">// map from definition ID to number of tokens with that ID</span>
    <span class="keyword">for</span><span class="delimiter">(</span><a title="sxr.Token" id="53806">token</a> &lt;- <a href="#53321" title="(f: sxr.Token =&gt; Unit)Unit">tokens</a>; <a title="Int" id="53828">definition</a> &lt;- <a href="#53806" title="sxr.Token">token</a>.<a href="Token.scala.html#12491" title="(f: Int =&gt; Unit)Unit">definitions</a><span class="delimiter">)</span>
      <a href="#53362" title="(key: Int, value: Int)Unit">idOccurrences</a><span class="delimiter">(</span><a href="#53828" title="Int">definition</a><span class="delimiter">)</span> = <a href="#53362" title="scala.collection.mutable.HashMap[Int,Int]">idOccurrences</a>.<span title="(key: Int, default: =&gt; Int)Int">getOrElse</span><span class="delimiter">(</span><a href="#53828" title="Int">definition</a>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
    <span class="comment">// The set of all definition IDs used by more than one token.  These tokens are generally not significant and it is invalid to have tokens</span>
    <span class="comment">//   with the same ID.</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.Set[Int]" id="53363">duplicates</a> = <span title="(elems: Int*)scala.collection.immutable.Set[Int]">Set</span><span class="delimiter">(</span> <a href="#53362" title="scala.collection.mutable.HashMap[Int,Int]">idOccurrences</a>.<span title="(p: (Int, Int) =&gt; Boolean)scala.collection.mutable.HashMap[Int,Int]">filter</span><span class="delimiter">(</span><a href="#53887" title="(Int, Int)">_</a>.<span title="=&gt; Int">_2</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>.<span title="(f: (Int, Int) =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.HashMap[Int,Int],Int,scala.collection.mutable.Iterable[Int]])scala.collection.mutable.Iterable[Int]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Iterable.Coll,Int,scala.collection.mutable.Iterable[Int]]" class="delimiter">(</span><a href="#53931" title="(Int, Int)">_</a>.<span title="=&gt; Int">_1</span><span class="delimiter">)</span>.<span title="=&gt; Seq[Int]">toSeq</span> : _*<span class="delimiter">)</span>
    <a href="#53321" title="Iterable[sxr.Token]">tokens</a>.<span title="(f: sxr.Token =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span> <a href="#54366" title="sxr.Token">_</a> <a href="Token.scala.html#12488" title="(ids: Set[Int])Unit">--=</a> <a href="#53363" title="scala.collection.immutable.Set[Int]">duplicates</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>
<span class="keyword">private</span> <span class="keyword">class</span> <a title="class Collapse extends java.lang.Object with NotNull with ScalaObject" id="9505">Collapse</a><a href="#9505" title="ScalaObject" class="delimiter">(</a><a title="Iterable[sxr.Token]" id="53274">tokens</a>: <span title="Iterable[sxr.Token]">Iterable</span><span class="delimiter">[</span>Token<span class="delimiter">]</span>, <a title="sxr.LinkMap" id="53275">links</a>: <a href="LinkMap.scala.html#9532" title="sxr.LinkMap">LinkMap</a><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="NotNull">NotNull</span>
<span class="delimiter">{</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="sxr.wrap.MutableMapWrapper[Int,Int]" id="53269">collapsedIDMap</a> = wrap.<a href="Wrappers.scala.html#9580" title="object sxr.wrap.Wrappers">Wrappers</a>.<a href="Wrappers.scala.html#44938" title="[K, V]=&gt; sxr.wrap.MutableMapWrapper[K,V]">basicMap</a><span title="sxr.wrap.MutableMapWrapper[Int,Int]" class="delimiter">[</span><span title="Int">Int</span>, <span title="Int">Int</span><span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="53271">apply</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">{</span>
    <a href="#53274" title="Iterable[sxr.Token]">tokens</a>.<span title="(f: sxr.Token =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#53272" title="(token: sxr.Token)Unit">collapseIDs</a><span class="delimiter">)</span>
    <a href="#53274" title="Iterable[sxr.Token]">tokens</a>.<span title="(f: sxr.Token =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#54750" title="sxr.Token">_</a>.<a href="Token.scala.html#12497" title="(remap: Int =&gt; Int)Unit">remapReference</a><span class="delimiter">(</span><a href="#53273" title="(oldID: Int)Int">remapTarget</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(token: sxr.Token)Unit" id="53272">collapseIDs</a><span class="delimiter">(</span><a title="sxr.Token" id="54736">token</a>: <a href="Token.scala.html#9569" title="sxr.Token">Token</a><span class="delimiter">)</span>
  <span class="delimiter">{</span>
    <a href="#54736" title="sxr.Token">token</a>.<a href="Token.scala.html#12491" title="=&gt; List[Int]">definitions</a> <span title="Unit" class="keyword">match</span>
    <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="54798">singleID</a> :: <a title="Int" id="54808">b</a> :: <a title="List[Int]" id="54809">tail</a> =&gt;
        <a href="#54736" title="sxr.Token">token</a>.<a href="Token.scala.html#12496" title="(to: Int)Unit">collapseDefinitions</a><span class="delimiter">(</span><a href="#54798" title="Int">singleID</a><span class="delimiter">)</span>
        <span class="delimiter">(</span><a href="#54808" title="Int">b</a> <a href="#54810" title="(x: Int)List[Int]">::</a> <a href="#54809" title="List[Int]">tail</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="54840">id</a> =&gt; <a href="Wrappers.scala.html#54393" title="(key: Int, value: Int)Unit">collapsedIDMap</a><span class="delimiter">(</span><a href="#54840" title="Int">id</a><span class="delimiter">)</span> = <a href="#54798" title="Int">singleID</a><span class="delimiter">)</span>
        <span class="comment">// If the token defines multiple stableIDs, the LinkMap must also be collapsed,</span>
        <span class="comment">// so that all stableIDs point to the retained internal id</span>
        <a href="#54736" title="sxr.Token">token</a>.<a href="Token.scala.html#12492" title="=&gt; List[String]">stableIDs</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="54851">s1</a> :: <a title="String" id="54861">s2</a> :: <a title="List[String]" id="54862">tail</a> =&gt;
            <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#54736" title="sxr.Token">token</a>.<a href="Token.scala.html#12493" title="=&gt; Option[String]">source</a>.<span title="=&gt; Boolean">isDefined</span>, <span title="java.lang.String(&quot;A token with stableIDs should have a source&quot;)" class="string">&quot;A token with stableIDs should have a source&quot;</span><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="String" id="54863">source</a> = <a href="#54736" title="sxr.Token">token</a>.<a href="Token.scala.html#12493" title="=&gt; Option[String]">source</a>.<span title="=&gt; String">get</span>
            <a href="#54736" title="sxr.Token">token</a>.<a href="Token.scala.html#12492" title="=&gt; List[String]">stableIDs</a>.<span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="String" id="54887">stable</a> =&gt; <a href="LinkMap.scala.html#43356" title="(src: String, stableID: String, id: Int)Unit">links</a><span class="delimiter">(</span><a href="#54863" title="String">source</a>, <a href="#54887" title="String">stable</a><span class="delimiter">)</span> = <a href="#54798" title="Int">singleID</a><span class="delimiter">)</span>
          <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(oldID: Int)Int" id="53273">remapTarget</a><span class="delimiter">(</span><a title="Int" id="54751">oldID</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#53269" title="=&gt; sxr.wrap.MutableMapWrapper[Int,Int]">collapsedIDMap</a>.<a href="Wrappers.scala.html#54377" title="(key: Int, default: =&gt; Int)Int">getOrElse</a><span class="delimiter">(</span><a href="#54751" title="Int">oldID</a>, <a href="#54751" title="Int">oldID</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>