<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>Collapse.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* sxr -- Scala X-Ray
 * Copyright 2009 Mark Harrah
 */</span>

<span class="keyword">package</span> sxr

<span class="keyword">private</span> <span class="keyword">object</span> <a title="object sxr.Collapse" id="9495">Collapse</a>
<span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(tokens: Iterable[sxr.Token], links: sxr.LinkMap)Unit" id="45900">apply</a><span class="delimiter">(</span><a title="Iterable[sxr.Token]" id="45902">tokens</a>: <span title="Iterable[sxr.Token]">Iterable</span><span class="delimiter">[</span>Token<span class="delimiter">]</span>, <a title="sxr.LinkMap" id="45903">links</a>: <a href="LinkMap.scala.html#9522" title="sxr.LinkMap">LinkMap</a><span class="delimiter">)</span>
  <span class="delimiter">{</span>
    <a href="#45901" title="(tokens: Iterable[sxr.Token])Unit">eliminateDuplicates</a><span class="delimiter">(</span><a href="#45902" title="Iterable[sxr.Token]">tokens</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="sxr.Collapse" id="50883">c</a> = <span title="sxr.Collapse" class="keyword">new</span> <a href="#9497" title="sxr.Collapse">Collapse</a><span class="delimiter">(</span><a href="#45902" title="Iterable[sxr.Token]">tokens</a>, <a href="#45903" title="sxr.LinkMap">links</a><span class="delimiter">)</span>
    <a href="#50834" title="()Unit">c</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(tokens: Iterable[sxr.Token])Unit" id="45901">eliminateDuplicates</a><span class="delimiter">(</span><a title="Iterable[sxr.Token]" id="50884">tokens</a>: <span title="Iterable[sxr.Token]">Iterable</span><span class="delimiter">[</span>Token<span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Int,Int]" id="50925">idOccurrences</a> = <span title="()scala.collection.mutable.HashMap[Int,Int]" class="keyword">new</span> scala.collection.mutable.<span title="scala.collection.mutable.HashMap[Int,Int]">HashMap</span><span class="delimiter">[</span>Int, Int<span class="delimiter">]</span> <span class="comment">// map from definition ID to number of tokens with that ID</span>
    <span class="keyword">for</span><span class="delimiter">(</span><a title="sxr.Token" id="51563">token</a> &lt;- <a href="#50884" title="(f: sxr.Token =&gt; Unit)Unit">tokens</a>; <a title="Int" id="51585">definition</a> &lt;- <a href="#51563" title="sxr.Token">token</a>.<a href="Token.scala.html#12484" title="(f: Int =&gt; Unit)Unit">definitions</a><span class="delimiter">)</span>
      <a href="#50925" title="(key: Int, value: Int)Unit">idOccurrences</a><span class="delimiter">(</span><a href="#51585" title="Int">definition</a><span class="delimiter">)</span> = <a href="#50925" title="scala.collection.mutable.HashMap[Int,Int]">idOccurrences</a>.<span title="(key: Int, default: =&gt; Int)Int">getOrElse</span><span class="delimiter">(</span><a href="#51585" title="Int">definition</a>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
    <span class="comment">// The set of all definition IDs used by more than one token.  These tokens are generally not significant and it is invalid to have tokens</span>
    <span class="comment">//   with the same ID.</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.Set[Int]" id="50926">duplicates</a> = <span title="(elems: Int*)scala.collection.immutable.Set[Int]">Set</span><span class="delimiter">(</span> <a href="#50925" title="scala.collection.mutable.HashMap[Int,Int]">idOccurrences</a>.<span title="(p: (Int, Int) =&gt; Boolean)scala.collection.mutable.HashMap[Int,Int]">filter</span><span class="delimiter">(</span><a href="#51644" title="(Int, Int)">_</a>.<span title="=&gt; Int">_2</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>.<span title="(f: (Int, Int) =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.HashMap[Int,Int],Int,scala.collection.mutable.Iterable[Int]])scala.collection.mutable.Iterable[Int]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Iterable.Coll,Int,scala.collection.mutable.Iterable[Int]]" class="delimiter">(</span><a href="#51688" title="(Int, Int)">_</a>.<span title="=&gt; Int">_1</span><span class="delimiter">)</span>.<span title="=&gt; Seq[Int]">toSeq</span> : _*<span class="delimiter">)</span>
    <a href="#50884" title="Iterable[sxr.Token]">tokens</a>.<span title="(f: sxr.Token =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span> <a href="#52338" title="sxr.Token">_</a> <a href="Token.scala.html#12481" title="(ids: Set[Int])Unit">--=</a> <a href="#50926" title="scala.collection.immutable.Set[Int]">duplicates</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>
<span class="keyword">private</span> <span class="keyword">class</span> <a title="class Collapse extends java.lang.Object with NotNull with ScalaObject" id="9497">Collapse</a><a href="#9497" title="ScalaObject" class="delimiter">(</a><a title="Iterable[sxr.Token]" id="50837">tokens</a>: <span title="Iterable[sxr.Token]">Iterable</span><span class="delimiter">[</span>Token<span class="delimiter">]</span>, <a title="sxr.LinkMap" id="50838">links</a>: <a href="LinkMap.scala.html#9522" title="sxr.LinkMap">LinkMap</a><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="NotNull">NotNull</span>
<span class="delimiter">{</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="sxr.wrap.MutableMapWrapper[Int,Int]" id="50832">collapsedIDMap</a> = wrap.<a href="Wrappers.scala.html#9572" title="object sxr.wrap.Wrappers">Wrappers</a>.<a href="Wrappers.scala.html#41353" title="[K, V]=&gt; sxr.wrap.MutableMapWrapper[K,V]">basicMap</a><span title="sxr.wrap.MutableMapWrapper[Int,Int]" class="delimiter">[</span><span title="Int">Int</span>, <span title="Int">Int</span><span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="50834">apply</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">{</span>
    <a href="#50837" title="Iterable[sxr.Token]">tokens</a>.<span title="(f: sxr.Token =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#50835" title="(token: sxr.Token)Unit">collapseIDs</a><span class="delimiter">)</span>
    <a href="#50837" title="Iterable[sxr.Token]">tokens</a>.<span title="(f: sxr.Token =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#52722" title="sxr.Token">_</a>.<a href="Token.scala.html#12490" title="(remap: Int =&gt; Int)Unit">remapReference</a><span class="delimiter">(</span><a href="#50836" title="(oldID: Int)Int">remapTarget</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(token: sxr.Token)Unit" id="50835">collapseIDs</a><span class="delimiter">(</span><a title="sxr.Token" id="52708">token</a>: <a href="Token.scala.html#9559" title="sxr.Token">Token</a><span class="delimiter">)</span>
  <span class="delimiter">{</span>
    <a href="#52708" title="sxr.Token">token</a>.<a href="Token.scala.html#12484" title="=&gt; List[Int]">definitions</a> <span title="Unit" class="keyword">match</span>
    <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="52770">singleID</a> :: <a title="Int" id="52780">b</a> :: <a title="List[Int]" id="52781">tail</a> =&gt;
        <a href="#52708" title="sxr.Token">token</a>.<a href="Token.scala.html#12489" title="(to: Int)Unit">collapseDefinitions</a><span class="delimiter">(</span><a href="#52770" title="Int">singleID</a><span class="delimiter">)</span>
        <span class="delimiter">(</span><a href="#52780" title="Int">b</a> <a href="#52782" title="(x: Int)List[Int]">::</a> <a href="#52781" title="List[Int]">tail</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="52812">id</a> =&gt; <a href="Wrappers.scala.html#52365" title="(key: Int, value: Int)Unit">collapsedIDMap</a><span class="delimiter">(</span><a href="#52812" title="Int">id</a><span class="delimiter">)</span> = <a href="#52770" title="Int">singleID</a><span class="delimiter">)</span>
        <span class="comment">// If the token defines multiple stableIDs, the LinkMap must also be collapsed,</span>
        <span class="comment">// so that all stableIDs point to the retained internal id</span>
        <a href="#52708" title="sxr.Token">token</a>.<a href="Token.scala.html#12485" title="=&gt; List[String]">stableIDs</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="52823">s1</a> :: <a title="String" id="52833">s2</a> :: <a title="List[String]" id="52834">tail</a> =&gt;
            <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#52708" title="sxr.Token">token</a>.<a href="Token.scala.html#12486" title="=&gt; Option[String]">source</a>.<span title="=&gt; Boolean">isDefined</span>, <span title="java.lang.String(&quot;A token with stableIDs should have a source&quot;)" class="string">&quot;A token with stableIDs should have a source&quot;</span><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="String" id="52835">source</a> = <a href="#52708" title="sxr.Token">token</a>.<a href="Token.scala.html#12486" title="=&gt; Option[String]">source</a>.<span title="=&gt; String">get</span>
            <a href="#52708" title="sxr.Token">token</a>.<a href="Token.scala.html#12485" title="=&gt; List[String]">stableIDs</a>.<span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="String" id="52859">stable</a> =&gt; <a href="LinkMap.scala.html#39759" title="(src: String, stableID: String, id: Int)Unit">links</a><span class="delimiter">(</span><a href="#52835" title="String">source</a>, <a href="#52859" title="String">stable</a><span class="delimiter">)</span> = <a href="#52770" title="Int">singleID</a><span class="delimiter">)</span>
          <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(oldID: Int)Int" id="50836">remapTarget</a><span class="delimiter">(</span><a title="Int" id="52723">oldID</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#50832" title="=&gt; sxr.wrap.MutableMapWrapper[Int,Int]">collapsedIDMap</a>.<a href="Wrappers.scala.html#52349" title="(key: Int, default: =&gt; Int)Int">getOrElse</a><span class="delimiter">(</span><a href="#52723" title="Int">oldID</a>, <a href="#52723" title="Int">oldID</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>